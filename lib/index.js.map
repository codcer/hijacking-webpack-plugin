{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["class HijackingPlugin {\r\n  // 在构造函数中获取传入的配置\r\n  constructor(options = {\r\n    id: 'app', // 自定义插入脚本位置\r\n    head: [],\r\n    body: [],\r\n    isRejectJACK: false,\r\n    filterTags: ['script', 'iframe'],\r\n    whiteURLS: [],\r\n    fn: null\r\n  }){\r\n    this.options = options;\r\n  }\r\n\r\n  _genScript (arr, htmlData, targetStr) {\r\n    let tplSRT = '';\r\n    arr.forEach(script => {\r\n      let scriptArrSTR = [\r\n        '<script'\r\n      ];\r\n\r\n      for(let attr in script) {\r\n        if(script[attr] && attr !== 'defer' && attr !== 'async') {\r\n          scriptArrSTR.push(`${attr}=\"${script[attr]}\"`);\r\n        }\r\n\r\n        if(script[attr] && (attr === 'defer' || attr === 'async')) {\r\n          scriptArrSTR.push(`${attr}`);\r\n        }\r\n      }\r\n\r\n      scriptArrSTR.push('></script>');\r\n      let _scriptSTR = scriptArrSTR.join(' ');\r\n      tplSRT += _scriptSTR + '\\n';\r\n    });\r\n    htmlData.html = htmlData.html.replace(`</${targetStr}>`, `${tplSRT}</${targetStr}>`);\r\n  }\r\n\r\n  // Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象\r\n  apply (compiler) {\r\n    // console.log(compiler); compiler为webpack配置信息 | 先指定自己编译，根据别人的编译结果操作\r\n    compiler.plugin('compilation', compilation => {\r\n      // console.log(compilation); // 自己插件行为处理\r\n      const { head, body, isRejectJACK, whiteURLS, filterTags } = this.options;\r\n\r\n      // html-webpack-plugin编译的入口\r\n      compilation.plugin('html-webpack-plugin-before-html-processing', (htmlData, callback) => {\r\n        if(isRejectJACK) {\r\n          htmlData.html = htmlData.html.replace('<head>', `<head><script fl2294-eddy>\r\n          (function(){var _filterTags=\"${filterTags}\",_whiteURLS=\"${whiteURLS}\";var srcFilterTags=_filterTags&&_filterTags.split(\",\")||[];var whiteList=_whiteURLS&&_whiteURLS.split(\",\")||[];var whiteListReg=[];whiteList.forEach(function(wl){var wlReg=new RegExp(\"/.+?//\"+wl+\"|//\"+wl+\"|.+?.\"+wl+\"|^\"+wl);whiteListReg.push(wlReg)});var inWhileList=function(addedNode){if(addedNode.src===\"\"&&addedNode.getAttribute(\"fl2294-eddy\")!==null){return true}var isInWhiteList=false;whiteListReg.forEach(function(wlReg){if(wlReg.test(addedNode.src)){isInWhiteList=true}});return isInWhiteList};var mutationHandler=function(records){records.forEach(function(record){Array.prototype.slice.call(record.addedNodes).forEach(function(addedNode){srcFilterTags.forEach(function(tagName){if(addedNode.tagName===tagName.toUpperCase()&&!inWhileList(addedNode)){addedNode.remove()}})})})};var MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,observeMutationSupport=!!MutationObserver;var html=document.getElementsByTagName(\"html\")[0];if(observeMutationSupport){new MutationObserver(mutationHandler).observe(html,{\"childList\":true,\"subtree\":true})}})();\r\n          </script>`);\r\n        }\r\n\r\n        if(head && head.length) {\r\n          this._genScript(head, htmlData, 'head');\r\n        }\r\n        if(body && body.length) {\r\n          this._genScript(body, htmlData, 'body');\r\n        }\r\n        callback(null, htmlData);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport default HijackingPlugin;\r\n"],"names":["options","_genScript","arr","htmlData","targetStr","tplSRT","forEach","scriptArrSTR","attr","script","push","_scriptSTR","join","html","replace","apply","compiler","plugin","_this","head","body","isRejectJACK","whiteURLS","filterTags","callback","length"],"mappings":"0OAEcA,yDAAU,IAChB,WACE,QACA,iBACQ,aACF,CAAC,SAAU,oBACZ,MACP,iHAECA,QAAUA,qBAGjBC,oBAAYC,EAAKC,EAAUC,OACrBC,EAAS,KACTC,QAAQ,gBACNC,EAAe,CACjB,eAGE,IAAIC,KAAQC,EACXA,EAAOD,IAAkB,UAATA,GAA6B,UAATA,KACxBE,KAAQF,OAASC,EAAOD,SAGpCC,EAAOD,IAAmB,UAATA,GAA6B,UAATA,KACzBE,QAAQF,KAIZE,KAAK,mBACdC,EAAaJ,EAAaK,KAAK,QACzBD,EAAa,SAEhBE,KAAOV,EAASU,KAAKC,aAAaV,MAAiBC,OAAWD,oBAIzEW,eAAOC,gBAEIC,OAAO,cAAe,kBAE+BC,EAAKlB,QAAzDmB,IAAAA,KAAMC,IAAAA,KAAMC,IAAAA,aAAcC,IAAAA,UAAWC,IAAAA,aAGjCN,OAAO,6CAA8C,SAACd,EAAUqB,GACvEH,MACQR,KAAOV,EAASU,KAAKC,QAAQ,+EACPS,mBAA2BD,0mCAIzDH,GAAQA,EAAKM,UACTxB,WAAWkB,EAAMhB,EAAU,QAE/BiB,GAAQA,EAAKK,UACTxB,WAAWmB,EAAMjB,EAAU,UAEzB,KAAMA"}